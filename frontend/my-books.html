<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои книги</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <nav id="navbar" class="navbar"></nav>
    <div class="container">
        <h1>Мои книги</h1>
        <button onclick="window.location.href='add-book.html'">Добавить книгу</button>
        <div id="myBooks" class="books-grid"></div>
        <p id="error" class="error"></p>
        <form id="editBookForm" style="display:none;">
            <input type="hidden" id="bookId">
            <div class="form-group">
                <label for="bookTitle">Название</label>
                <input type="text" id="bookTitle" required>
            </div>
            <div class="form-group">
                <label for="bookAuthor">Автор</label>
                <input type="text" id="bookAuthor" required>
            </div>
            <div class="form-group">
                <label for="bookGenre">Жанр</label>
                <select id="bookGenre" required>
                    <option value="фантастика">Фантастика</option>
                    <option value="детектив">Детектив</option>
                    <option value="роман">Роман</option>
                    <option value="классика">Классика</option>
                </select>
            </div>
            <div class="form-group">
                <label for="bookYear">Год издания</label>
                <input type="number" id="bookYear" required>
            </div>
            <div class="form-group">
                <label for="bookCondition">Состояние</label>
                <select id="bookCondition" required>
                    <option value="новая">Новая</option>
                    <option value="хорошее">Хорошее</option>
                    <option value="удовлетворительное">Удовлетворительное</option>
                </select>
            </div>
            <div class="form-group">
                <label for="bookCity">Город</label>
                <input type="text" id="bookCity" required>
            </div>
            <div class="form-group">
                <label for="bookImage">URL обложки</label>
                <input type="text" id="bookImage" required>
            </div>
            <div class="form-group">
                <label for="bookContacts">Контакты для связи</label>
                <input type="text" id="bookContacts" placeholder="Например: email@example.com или @telegram">
            </div>
            <button type="submit">Сохранить изменения</button>
            <button type="button" onclick="hideEditForm()">Отменить</button>
        </form>
    </div>
    <script src="js/api.js"></script>
    <script>
        function renderNavbar() {
            const token = localStorage.getItem('token');
            const navbar = document.getElementById('navbar');
            navbar.innerHTML = `
                <a href="index.html">Главная</a>
                ${token ? `
                    <a href="profile.html">Профиль</a>
                    <button onclick="logout()">Выйти</button>
                ` : `
                    <a href="login.html">Войти</a>
                    <a href="register.html">Регистрация</a>
                `}
            `;
            if (!token) {
                window.location.href = 'login.html';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('isAdmin');
            window.location.href = 'login.html';
        }

        async function loadMyBooks() {
            const token = localStorage.getItem('token');
            try {
                const books = await getUserBooks(token);
                const myBooksDiv = document.getElementById('myBooks');
                if (books.length === 0) {
                    myBooksDiv.innerHTML = '<p>У вас пока нет добавленных книг.</p>';
                    return;
                }
                myBooksDiv.innerHTML = books.map(book => `
                    <div class="book-card">
                        <h3>${book.title}</h3>
                        <p>Автор: ${book.author}</p>
                        <p>Город: ${book.city}</p>
                        <p>Состояние: ${book.condition}</p>
                        <p>Контакты: ${book.contacts || 'Не указаны'}</p>
                        <img src="${book.cover_image}" alt="${book.title}" class="book-image" onerror="this.src='https://via.placeholder.com/150';"> 
                        <div class="book-actions">
                            <button onclick="showEditForm(${book.id}, '${book.title.replace(/'/g, "\\'")}', '${book.author.replace(/'/g, "\\'")}', '${book.genre}', ${book.year}, '${book.condition}', '${book.city}', '${book.cover_image.replace(/'/g, "\\'")}', '${book.contacts ? book.contacts.replace(/'/g, "\\'") : ''}')">Редактировать</button>
                            <button onclick="deleteBook(${book.id})">Удалить</button>
                            <a href="book.html?id=${book.id}" class="details-btn">Подробнее</a>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                document.getElementById('error').textContent = `Ошибка загрузки книг: ${err.message}`;
            }
        }

        function showEditForm(id, title, author, genre, year, condition, city, cover_image, contacts) {
            document.getElementById('bookId').value = id;
            document.getElementById('bookTitle').value = title;
            document.getElementById('bookAuthor').value = author;
            document.getElementById('bookGenre').value = genre;
            document.getElementById('bookYear').value = year;
            document.getElementById('bookCondition').value = condition;
            document.getElementById('bookCity').value = city;
            document.getElementById('bookImage').value = cover_image;
            document.getElementById('bookContacts').value = contacts || '';
            document.getElementById('editBookForm').style.display = 'block';
        }

        function hideEditForm() {
            document.getElementById('editBookForm').style.display = 'none';
            document.getElementById('editBookForm').reset();
        }

        document.getElementById('editBookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const bookId = parseInt(document.getElementById('bookId').value);
            const data = {
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                genre: document.getElementById('bookGenre').value,
                year: parseInt(document.getElementById('bookYear').value),
                condition: document.getElementById('bookCondition').value,
                city: document.getElementById('bookCity').value,
                cover_image: document.getElementById('bookImage').value,
                contacts: document.getElementById('bookContacts').value || null
            };
            try {
                await updateBook(bookId, data, token);
                alert("Книга успешно отредактирована!");
                hideEditForm();
                loadMyBooks();
            } catch (err) {
                document.getElementById('error').textContent = `Ошибка: ${err.message}`;
            }
        });

        async function deleteBook(bookId) {
            const token = localStorage.getItem('token');
            if (!confirm('Вы уверены, что хотите удалить книгу?')) return;
            try {
                await apiRequest(`/books/${bookId}`, 'DELETE', null, token);
                alert("Книга успешно удалена!");
                loadMyBooks();
            } catch (err) {
                document.getElementById('error').textContent = `Ошибка удаления: ${err.message}`;
            }
        }

        window.onload = () => {
            renderNavbar();
            loadMyBooks();
        };
    </script>
</body>

</html>